<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password</title>
  <link rel="stylesheet" href="about-style.css" />
</head>
<body>
  <header class="navbar">
    <div class="brand">
      <div class="brand-mark">GD</div>
      <div class="brand-text">
        <div class="brand-name">Good Driver</div>
        <div class="brand-sub">Application Portal</div>
      </div>
    </div>

    <nav class="nav-actions">
      <a href="about.html" class="btn btn-primary">About</a>
      <a href="application.html" class="btn btn-primary">Apply Now!</a>
      <a href="login.html" class="btn btn-primary">Sign In</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-header">
        <h1>Reset your password</h1>
        <p class="muted">First, verify your account details. Then you can set a new password.</p>
      </div>

      <!-- STEP 1: verify -->
      <form class="form" id="verifyForm">
        <label class="field">
          <span>Username</span>
          <input type="text" name="username" placeholder="yourusername" required />
        </label>

        <label class="field">
          <span>Email</span>
          <input type="email" name="email" placeholder="you@example.com" required />
        </label>

        <label class="field">
          <span>Phone number</span>
          <input type="tel" name="phone_number" placeholder="555-555-5555" required />
        </label>

        <button class="primary-btn" type="submit">Verify</button>

        <p class="fineprint">
          Back to <a class="link" href="/Website/login.html">Sign In</a>
        </p>
      </form>

      <!-- STEP 2: reset (hidden until verified) -->
      <form class="form" id="resetForm" style="display:none;">
        <label class="field">
          <span>New password</span>
          <input
            id="newPassword"
            type="password"
            name="newPassword"
            minlength="8"
            pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}"
            title="Must be 8+ characters and include 1 uppercase letter, 1 lowercase letter, and 1 number."
            required
            />
        </label>

        <label class="field">
          <span>Confirm new password</span>
          <input
            id="confirmPassword"
            type="password"
            name="confirmPassword"
            minlength="8"
            pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}"
            title="Must be 8+ characters and include 1 uppercase letter, 1 lowercase letter, and 1 number."
            required
            />
        </label>

        <button class="primary-btn" type="submit">Update password</button>

        <p class="muted small" id="resetHint" style="margin-top: 10px;"></p>
      </form>

      <p class="muted small" id="message" style="margin-top: 12px;"></p>
    </section>
  </main>

  <footer class="footer">
    <span class="muted small">© <span id="year"></span> Good Driver · All rights reserved</span>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const verifyForm = document.getElementById("verifyForm");
    const resetForm = document.getElementById("resetForm");
    const msg = document.getElementById("message");
    const resetHint = document.getElementById("resetHint");

    // We store a short-lived resetId returned by the server (not the user_id).
    let resetId = null;

    verifyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";

        const formData = new FormData(verifyForm);
        const payload = {
            username: formData.get("username").trim(),
            email: formData.get("email").trim(),
            phone_number: formData.get("phone_number").trim(),
        };
        console.log("VERIFY payload:", payload);

        try {
            const res = await fetch("/api/auth/forgot/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            });

            const data = await res.json();

            if (!res.ok) {
            msg.textContent = data?.message || "Verification failed.";
            return;
            }

            // Even if the server uses generic responses, it can still provide a resetId only on success.
            resetId = data.resetId;
            verifyForm.style.display = "none";
            resetForm.style.display = "block";
            resetHint.textContent = "Verified. Please enter a new password (8+ characters).";
        } catch (err) {
            msg.textContent = "Network error. Try again.";
        }
    });

    resetForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";

        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (newPassword !== confirmPassword) {
            msg.textContent = "Passwords do not match.";
            return;
        }

        if (!resetId) {
            msg.textContent = "Missing reset session. Please verify again.";
            return;
        }

        if (newPassword !== confirmPassword) {
            msg.textContent = "Passwords do not match.";
            return;
        }

        const strongPw = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
        if (!strongPw.test(newPassword)) {
            msg.textContent = "Password must be 8+ chars and include 1 uppercase, 1 lowercase, and 1 number.";
            return;
        }

        try {
        const res = await fetch("/api/auth/forgot/reset", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ resetId, newPassword }),
        });

        const data = await res.json();

        if (!res.ok) {
            msg.textContent = data?.message || "Password reset failed.";
            return;
        }

        msg.textContent = "Password updated! You can now sign in.";
        resetForm.reset();
        setTimeout(() => window.location.href = "login.html", 1200);
        } catch (err) {
        msg.textContent = "Network error. Try again.";
        }
    });
  </script>
</body>
</html>
